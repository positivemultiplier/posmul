/**
 * Settle Prediction Game Use Case
 *
 * 예측 게임 정산 비즈니스 로직을 처리합니다.
 * - 정답 확인 및 게임 종료
 * - 참여자별 정확도 계산
 * - PmcAmount 보상 분배
 * - Money Wave 분배 연동
 *
 * @author PosMul Development Team
 * @since 2024-12
 */

import { PredictionGameId, Result, UserId, UseCaseError, isFailure } from '@posmul/auth-economy-sdk';
import { MoneyWaveCalculatorService } from "../../../../shared/economy-kernel/services/money-wave-calculator.service";
import {
  BaseDomainEvent,
  publishEvent,
} from "../../../../shared/events/domain-events";
import { IPredictionGameRepository } from "../../domain/repositories/prediction-game.repository";
import { PredictionEconomicService } from "../../domain/services/prediction-economic.service";

/**
 * PmcAmount 획득 이벤트 (Domain Event 규격 준수)
 */
class PmcEarnedFromPredictionEvent extends BaseDomainEvent {
  constructor(
    userId: UserId,
    gameId: PredictionGameId,
    predictionId: string,
    amount: number,
    accuracyScore: number,
    details: string
  ) {
    super("PmcAmount_EARNED_FROM_PREDICTION", userId, {
      gameId,
      predictionId,
      amount,
      accuracyScore,
      source: "prediction-success",
      details,
    });
  }
}

/**
 * 예측 게임 정산 완료 이벤트
 */
class PredictionGameSettledEvent extends BaseDomainEvent {
  constructor(
    gameId: PredictionGameId,
    correctOptionId: string,
    totalRewardDistributed: number,
    winnersCount: number,
    settlementResults: Array<{
      userId: UserId;
      predictionId: string;
      isWinner: boolean;
      accuracyScore: number;
      rewardAmount: number;
    }>
  ) {
    super("PREDICTION_GAME_SETTLED", gameId, {
      correctOptionId,
      totalRewardDistributed,
      winnersCount,
      settlementResults,
    });
  }
}

/**
 * Money Wave 재분배 트리거 이벤트
 */
class MoneyWaveRedistributionTriggeredEvent extends BaseDomainEvent {
  constructor(
    gameId: PredictionGameId,
    redistributionAmount: number,
    winnersCount: number,
    reason: string
  ) {
    super("MONEY_WAVE_REDISTRIBUTION_TRIGGERED", gameId, {
      gameId,
      redistributionAmount,
      winnersCount,
      reason,
    });
  }
}

/**
 * 예측 게임 정산 요청 DTO
 */
export interface SettlePredictionGameRequest {
  readonly gameId: PredictionGameId;
  readonly correctOptionId: string;
  readonly adminUserId: UserId; // 정산을 실행하는 관리자
  readonly finalResults?: Record<string, any>; // 추가 결과 데이터
}

/**
 * 예측 게임 정산 응답 DTO
 */
export interface SettlePredictionGameResponse {
  readonly gameId: PredictionGameId;
  readonly correctOptionId: string;
  readonly totalParticipants: number;
  readonly winnersCount: number;
  readonly totalStakePool: number;
  readonly totalRewardDistributed: number;
  readonly averageAccuracyScore: number;
  readonly settlementResults: Array<{
    userId: UserId;
    predictionId: string;
    selectedOptionId: string;
    isWinner: boolean;
    stakeAmount: number;
    accuracyScore: number;
    rewardAmount: number;
  }>;
}

/**
 * 예측 게임 정산 Use Case
 */
export class SettlePredictionGameUseCase {
  constructor(
    private readonly predictionGameRepository: IPredictionGameRepository,
    private readonly predictionEconomicService: PredictionEconomicService,
    private readonly moneyWaveCalculator: MoneyWaveCalculatorService
  ) {}

  

  async execute(
    request: SettlePredictionGameRequest
  ): Promise<Result<SettlePredictionGameResponse, UseCaseError>> {
    try {
      // 1. 입력 검증
      const validationResult = this.validateRequest(request);
      if (!validationResult.success) {
        return {
          success: false,
          error: new UseCaseError(
            "Invalid settlement request") ? validationResult.error : undefined
          ),
        };
      }

      // 2. 예측 게임 조회
      const gameResult = await this.predictionGameRepository.findById(
        request.gameId
      );
      if (!gameResult.success || !gameResult.data) {
        return {
          success: false,
          error: new UseCaseError("Prediction game not found"))
      if (!predictionGame.status.isEnded()) {
        return {
          success: false,
          error: new UseCaseError("Game must be completed before settlement")) => opt.id === request.correctOptionId
      );
      if (!validOption) {
        return {
          success: false,
          error: new UseCaseError("Invalid correct option ID"))
      // PredictionGame에 settle 메서드가 없으므로 직접 정산 로직 구현

      // 6. 정산 결과 분석
      const predictions = Array.from(predictionGame.predictions.values());
      const gameStats = predictionGame.getStatistics();

      const winners = predictions.filter(
        (p) =>
          p.selectedOptionId === request.correctOptionId &&
          p.accuracyScore !== undefined
      );

      const totalStakePool = gameStats.totalStake;
      let totalRewardDistributed = 0;
      let totalAccuracyScore = 0;

      // 7. 각 당첨자에게 PmcAmount 보상 계산 및 분배 (PredictionEconomicService 활용)
      const settlementResults = [];

      for (const prediction of predictions) {
        const isWinner =
          prediction.selectedOptionId === request.correctOptionId;
        const accuracyScore = prediction.accuracyScore || 0;
        let rewardAmount = 0;

        if (isWinner) {
          // Agency Theory & CAPM 기반 PmcAmount 보상 계산
          const rewardCalculation =
            this.predictionEconomicService.calculatePmcReward(
              prediction.userId,
              prediction.stake,
              accuracyScore,
              prediction.confidence,
              gameStats.totalStake / 1000, // 게임 중요도 점수
              predictions.length,
              winners.length
            );

          rewardAmount = rewardCalculation.finalReward;
          totalRewardDistributed += rewardAmount;

          // PredictionEconomicService를 통한 PmcAmount 보상 처리
          const pmcRewardResult =
            await this.predictionEconomicService.processPmcReward(
              prediction.userId,
              request.gameId,
              prediction.id,
              rewardCalculation
            );

          if (!pmcRewardResult.success) {
            console.error(
              "Failed to process PmcAmount reward:",
              isFailure(pmcRewardResult) ? pmcRewardResult.error : undefined
            );
            // 보상 처리 실패해도 정산은 계속 진행
          }
        }

        settlementResults.push({
          userId: prediction.userId,
          predictionId: prediction.id,
          selectedOptionId: prediction.selectedOptionId,
          isWinner,
          stakeAmount: prediction.stake,
          accuracyScore,
          rewardAmount,
        });

        totalAccuracyScore += accuracyScore;
      }

      // 8. 게임 상태 저장
      const saveResult =
        await this.predictionGameRepository.save(predictionGame);
      if (!saveResult.success) {
        return {
          success: false,
          error: new UseCaseError(
            "Failed to save settled game") ? saveResult.error : undefined
          ),
        };
      }

      // 9. 게임 정산 완료 이벤트 발행
      const gameSettledEvent = new PredictionGameSettledEvent(
        request.gameId,
        request.correctOptionId,
        totalRewardDistributed,
        winners.length,
        settlementResults
      );

      await publishEvent(gameSettledEvent);

      // 10. Money Wave 2/3 트리거 (미소비 PmcAmount 재분배)
      await this.triggerMoneyWaveRedistribution(
        predictionGame,
        totalRewardDistributed,
        winners.length
      );

      // 11. 응답 생성
      const averageAccuracyScore =
        predictions.length > 0 ? totalAccuracyScore / predictions.length : 0;

      return {
        success: true,
        data: {
          gameId: request.gameId,
          correctOptionId: request.correctOptionId,
          totalParticipants: predictions.length,
          winnersCount: winners.length,
          totalStakePool,
          totalRewardDistributed,
          averageAccuracyScore,
          settlementResults,
        },
      };
    } catch (error) {
      return {
        success: false,
        error: new UseCaseError(
          "Unexpected error in SettlePredictionGameUseCase") )
        ),
      };
    }
  }

  /**
   * Money Wave 2/3 재분배 트리거
   */
  private async triggerMoneyWaveRedistribution(
    predictionGame: any,
    totalRewardDistributed: number,
    winnersCount: number
  ): Promise<void> {
    try {
      // Money Wave 2: 미소비 PmcAmount 재분배 계산 (추후 구현)
      // calculateUnusedPmcRedistribution 메서드가 아직 구현되지 않았으므로
      // 기본 재분배 로직만 적용

      if (winnersCount > 0 && totalRewardDistributed > 0) {
        // Money Wave 재분배 이벤트 발행
        const redistributionEvent = new MoneyWaveRedistributionTriggeredEvent(
          predictionGame.id,
          totalRewardDistributed,
          winnersCount,
          "unused-pmc-redistribution"
        );

        await publishEvent(redistributionEvent);
      }
    } catch (error) {
      // 재분배 실패는 로그만 남기고 정산은 계속 진행
      console.warn("Money Wave redistribution failed:", error);
    }
  }

  /**
   * 요청 검증
   */
  private validateRequest(
    request: SettlePredictionGameRequest
  ): Result<void, Error> {
    if (!request.gameId) {
      return {
        success: false,
        error: new Error("Game ID is required"),
      };
    }

    if (!request.correctOptionId || request.correctOptionId.trim() === "") {
      return {
        success: false,
        error: new Error("Correct option ID is required"),
      };
    }

    if (!request.adminUserId) {
      return {
        success: false,
        error: new Error("Admin user ID is required"),
      };
    }

    return { success: true, data: undefined };
  }
}
