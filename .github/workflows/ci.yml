name: PosMul CI

on:
  push:
    branches: [main, "phase*"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm exec turbo build

  lint:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm exec turbo test --cache-dir=.turbo -- --coverage

  e2e:
    runs-on: ubuntu-latest
    needs: test
    
    # E2E 테스트를 위한 서비스 (Supabase local)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: Install dependencies & browsers
        run: |
          pnpm install --frozen-lockfile
          npx playwright install --with-deps chromium

      - name: Setup E2E environment
        run: |
          echo "Setting up E2E test environment variables..."
          
          # .env.test 파일 생성
          cat > apps/posmul-web/.env.test << EOF
          NODE_ENV=test
          NEXT_PUBLIC_APP_URL=http://localhost:3000
          
          # 테스트용 Supabase 설정 (실제 값은 secrets에서)
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.TEST_SUPABASE_URL || 'http://localhost:54321' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.TEST_SUPABASE_ANON_KEY || 'test-anon-key' }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.TEST_SUPABASE_SERVICE_KEY || 'test-service-key' }}
          
          # 테스트 데이터베이스
          DATABASE_URL=postgresql://postgres:postgres@localhost:5432/postgres
          
          # E2E 테스트 사용자
          E2E_TEST_USER_EMAIL=test@example.com
          E2E_TEST_USER_PASSWORD=testpassword123
          E2E_ADMIN_EMAIL=admin@example.com
          E2E_ADMIN_PASSWORD=adminpassword123
          
          # 테스트 설정
          SEED_TEST_DATA=true
          RESET_DB_ON_START=true
          
          # API 키들 (테스트 모드)
          OPENAI_API_KEY=test-openai-key
          ANTHROPIC_API_KEY=test-anthropic-key
          EOF

      - name: Run Playwright tests
        run: pnpm e2e --reporter=github
        env:
          CI: true
          
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/posmul-web/playwright-report/
          retention-days: 30

  gen-types:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Supabase types (if secrets available)
        run: |
          if [ -n "${{ secrets.SUPABASE_PROJECT_ID }}" ]; then
            echo "Generating Supabase types..."
            pnpm --filter apps/posmul-web tsx apps/posmul-web/scripts/generate-types-simple.ts
          else
            echo "Skipping type generation - no Supabase secrets configured"
          fi
